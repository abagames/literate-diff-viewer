## ワンボタンミニゲーム PIN CLIMB を作る

この記事では、[crisp-game-lib](https://github.com/abagames/crisp-game-lib)を使ったワンボタンミニゲームの作り方を説明します。

ワンボタンミニゲームを作るには、ワンボタンにどのような機能を割り当てるかが重要です。詳しくは、以下の記事を参照ください。

- [ワンボタンゲームをたくさん作ったので、その作り方をおさらいしたい](https://aba.hatenablog.com/entry/2021/08/08/195706)

今回作るゲームでは、ボタンに「伸びる」という機能を割り当てます。ゲームのルールを以下に示します。

- あなたはくるくる回る「ひも」を操作します
- ひもはボタンを押している間は伸びて、ボタンを離すと縮みます
- ひもは「ピン」を中心に回ります
- ピンは画面の上端から出現して下方向にスクロールします
- ひもが他のピンに引っかかると、そのピンが中心になるように移動します
- ひもが画面の下端に移動するとゲームオーバーです

<br><br><br><br>

(src) [0_template.js](./src/0_template.js)

### テンプレートのソースコードを準備する

`crisp-game-lib` を使ってゲームを作るには、テンプレートとなるソースコードを準備する必要があります。詳しくは、[始め方](https://github.com/abagames/crisp-game-lib/blob/master/README_ja.md#%E5%A7%8B%E3%82%81%E6%96%B9)を見てください。

<br>

ここでこの記事の見方を説明します。画面右にソースコードが表示されていますか？表示されていない場合は、この文章が画面中央より上に来るまで、画面を下へスクロールしてください。

画面右には新たに追記したソースコードが表示されます。表示は[diff のユニファイド形式](<https://ja.wikipedia.org/wiki/Diff#%E3%83%A6%E3%83%8B%E3%83%95%E3%82%A1%E3%82%A4%E3%83%89%E5%BD%A2%E5%BC%8F_(Unified_format)>)で表示され、行頭に `+` がある行が追記した行、`-` がある行が削除した行です。

画面右下には、現在のソースコードで実現されるゲーム画面が表示されます。今はスコアとハイスコアが表示されているだけです。

<br>

画面右のテンプレートを見てみましょう。`title` , `description` はゲームのタイトルと説明を設定するための変数、`characters` は画面に表示するドット絵を定義するための変数、`options` はゲームの設定を行うための変数です。これらの変数は後ほど設定します。

`update` 関数に、ゲームのロジックを記述します。`update` 関数は 1 秒に 60 回呼び出され、ゲーム画面の描画やマウス操作に反応する処理などを行います。

`update` 関数内にある `ticks` 変数は、ゲーム開始時は 0 で、1/60 秒ごとに 1 加算されます。`if (!ticks) {}` は、`if (ticks === 0) {}` と同じ意味で、ゲーム開始時に行う初期化の処理が、`{}` 内で行えます。

<br><br><br><br>

(src) [1_pins_variable.js](./src/1_pins_variable.js)

### ピンを表示する

ピンを画面に表示します。`pins` 配列変数を宣言します。必須ではないですが、`@type` を含むコメントを使って、変数の型を宣言すると、エラー検出やコード補完をする際に役立ちます。`Vector` クラスは、(x, y)座標を扱う際に便利な関数群を備えた、 2 次元のベクトルを扱うクラスです。

`pins` 変数を `[vec(50, 5)]` で初期化します。`vec()` 関数は、第 1 引数を x 座標、第 2 引数を y 座標とした、`Vector` インスタンスを生成します。

`forEach` を使って、`pins` の各要素を座標として `box`、つまり四角を描画します。`box` 関数は第 1 引数に座標を、第 2 引数にその大きさを指定します。`crisp-game-lib` の画面は 100x100 ドットで構成されていて、左上が(0, 0)、右下が(99, 99)です。

<br><br><br><br>

(src_silent) 1a_pins_variables_p.js

(src) [2_add_pins.js](./src/2_add_pins.js)

### ピンを追加しスクロールさせる

ピンをある程度の間隔で画面上端から出現させ、下にスクロールさせます。`nextPinDist` に次のピンまでの距離を設定します。`scr` にはスクロールする y 座標の距離を設定し、各ピンの y 座標に `scr` の値を加えます。

`nextPinDist` が 0 より小さな値になった場合、配列の `push` 関数を使って新たなピンを追加します。ピンの x 座標は `rnd` 関数を使ってランダムに設定します。`rnd` 関数は第 1 引数から第 2 引数までの間の値を返します。次のピンまでの距離も `rnd` 関数を使って算出し、`nextPinDist` に加算します。

<br><br><br><br>

(src) [3_remove_pins.js](./src/3_remove_pins.js)

### 画面から外れたピンを削除する

画面下へスクロールして画面から外れたピンを削除しないと、いつまでも配列に残り続けてしまいます。`forEach` の代わりに `remove` 関数を使って画面から外れたピンを削除します。`remove` 関数は第 1 引数に繰り返し要素を取り出す配列を、第 2 引数に取り出した要素を引数として処理を行う関数を指定します。第 2 引数の関数が `true` を返すと、この要素は配列から削除されます（この関数は [lodash の remove 関数](https://lodash.com/docs/#remove) とほぼ同じ動作をします）。画面から外れた ( `pin.y > 102`  ) 時に `true` を返すことで、ピンを削除します。

<br><br><br><br>

(src) [4_add_cord.js](./src/4_add_cord.js)

### ひもを追加する

変数 `cord` でひもを管理します。`cord` はひもの角度 ( `angle` ) 、長さ ( `length` ) 、中心のピン ( `pin` ) をプロパティに持ちます。`cord` も `if (!ticks) {}` 内で初期化します。

<br><br><br><br>

(src) [5_draw_cord.js](./src/4_draw_cord.js)

### ひもを描画する

ひもの角度を加算して回転させます。その後、`line` 関数を使ってひもを描画します。`line` 関数は第 1 引数と第 2 引数の座標をつなぐ線を描画します。`Vector` の `addWithAngle` 関数は、第 1 引数の角度方向に、第 2 引数の距離分、座標をずらします。

<br><br><br><br>

(src) [6_extend_cord.js](./src/6_extend_cord.js)

### ボタンを押すとひもが伸びる

`input` 変数には、マウスやタッチパネル、キーボードからの入力状態が格納されます。`input.isPressed` 変数はボタンやタッチパネル、キーが押されている時に `true` になります。ここでは、ボタンを押した時にひもの長さを加算し、離した時に長さの初期値である `cordLength` に戻しています。

画面右下のゲーム画面にマウスカーソルを合わせて、マウスボタンを押してみてください。ひもが伸びる動作が確認できます。

また、このページでは、マウスカーソルがゲーム画面の外にある場合でもゲームの動作が分かりやすいように、ボタンを押す動作がランダムに行われます。ひもが自動的に伸びたり縮んだりするのは、この動作が行われているためです。

<br><br><br><br>

(src) [7_scroll_cord.js](./src/7_scroll_cord.js)

### ひもの位置に合わせてスクロールする

このゲームではピンが画面上から下方向へスクロールするため、ひもが画面上部にあると画面の先の状況を見るのが難しくなります。そのため、ひもの中心のピンの y 座標が 80 より小さい場合、スクロールする距離を増やします。

また、ひもが画面下へ到達した場合にゲームを終了させる処理も追加します。`end` 関数を呼び出すことで、ゲームオーバー状態へ遷移します。

<br><br><br><br>

(src) [8_move_to_pin.js](./src/8_move_to_pin.js)

### ひもが別のピンへ移動する

ひもが別のピンに引っかかった場合、そのピンへひもが移動する処理を追加します。あるピンがひもが衝突した時に、ひもをそのピンへ移動することで、この処理を実現します。

衝突を判定するには、`box` 関数の返り値を使います。`isColliding.rect.black` が `true` であるかを確認することで、box が黒の四角に衝突しているかを判定できます。ひもを描画する `line` 関数は、複数の四角で線を描画します。そのため、この確認を行うことで、描画したピンがひもと衝突するかを判定できます。

`box` 関数以外の描画関数も、同様に `isColliding` を確認することで、描画時に別の四角に衝突するかを確認できます。

ひもと衝突したピンを `nextPin` 変数に格納し、ひもを `nextPin` へ移動させ、ひもの長さを初期値である `cordLength` へ戻します。

<br><br><br><br><br><br><br><br><br><br>
<br><br><br><br><br><br><br><br><br><br>
